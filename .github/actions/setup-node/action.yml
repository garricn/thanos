name: 'Setup Node.js and Dependencies'
description: 'Sets up Node.js and installs dependencies with caching'

runs:
  using: 'composite'
  steps:
    - name: Read .nvmrc
      id: nvmrc
      shell: bash
      run: |
        {
          echo "NODE_VERSION=$(< .nvmrc)"
        } >> "$GITHUB_OUTPUT"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.nvmrc.outputs.NODE_VERSION }}
        cache: npm

    - name: Cache node_modules
      uses: actions/cache@v4
      id: node-modules-cache
      with:
        path: |
          **/node_modules
          ~/.cache/Cypress
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-modules-

    - name: Check package sync
      if: steps.node-modules-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        echo "Node version: $(node -v)"
        echo "npm version: $(npm -v)"
        echo "Checking if package.json and package-lock.json are in sync..."
        HUSKY=0 npm ci --dry-run || { echo "Dry run failed"; npm diff; exit 1; }

    - name: Install dependencies
      if: steps.node-modules-cache.outputs.cache-hit != 'true'
      shell: bash
      run: HUSKY=0 npm ci
