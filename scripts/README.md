# Scripts Directory

This directory contains various utility scripts used for building, testing, and maintaining the project.

## SonarCloud Integration Scripts

### cleanup-test-reports.js

This script manages the test execution reports needed by SonarCloud. It performs the following:

1. Checks if `test-report.xml` exists at the root directory (generated by jest-sonar-reporter)
2. If found, copies it to `coverage/sonar-report.xml` which is the location expected by SonarCloud
3. Removes the original `test-report.xml` file to keep the directory clean
4. If no report is found, it falls back to running `jest-to-sonar.js` to generate a mock report

This script is automatically run as part of the `test:sonar` npm script and in the GitHub Actions workflow.

### jest-to-sonar.js

This script is a fallback for generating SonarQube-compatible test execution reports when the normal test process doesn't generate one. It follows a simplified approach:

1. First checks if `coverage/sonar-report.xml` already exists
2. If not, looks for `junit.xml` files in the project coverage structure
3. If still no results found, generates mock test data
4. Creates or updates the `coverage/sonar-report.xml` file

The script has been streamlined to focus only on the specific paths where test results would be found in this project, making it efficient and straightforward.

## Usage

These scripts are automatically called by various npm scripts:

```json
"test:sonar": "rm -rf coverage && rm -rf node_modules/.cache && JEST_SONAR_REPORTER_OUTPUT_DIR='./coverage' JEST_SONAR_REPORTER_OUTPUT_NAME='sonar-report.xml' npm run test --workspace=apps/web -- --coverage --testResultsProcessor=jest-sonar-reporter && npm run test --workspace=apps/api -- --coverage --testResultsProcessor=jest-sonar-reporter && find coverage/apps -name \"lcov.info\" -exec cat {} \\; > coverage/lcov.info && node scripts/cleanup-test-reports.js"
```

You can also run them directly:

```bash
# Clean up test reports and ensure they're in the right location
node scripts/cleanup-test-reports.js

# Generate a mock sonar report if needed
node scripts/jest-to-sonar.js
```

## Testing Strategy

The scripts directory follows a comprehensive testing strategy focused on validating utility scripts and git hooks:

### Test Organization

- Tests are located in `__tests__` directories alongside the scripts they test
- Shared test utilities are centralized in `__tests__/utils/` for common testing patterns
- Each test file focuses on specific behaviors rather than implementation details

### Testing Principles

- **Behavior-First**: Tests describe expected script behaviors rather than implementation details
- **DRY (Don't Repeat Yourself)**: Common test patterns are extracted into shared utilities
- **Maintainability**: Tests are structured to be easy to update when script behavior changes
- **Readability**: Clear test descriptions and organization make tests self-documenting

### Test Utilities

The `__tests__/utils/` directory contains shared testing infrastructure:

- `test-utils.js`: Common test setup and teardown functions
- `shell-utils.js`: Utilities for testing shell script execution and output
- `git-utils.js`: Helpers for testing git-related operations

### Example Test Structure

```javascript
const { setupTestEnv, cleanupTestEnv } = require('./utils/test-utils');
const { runShellCommand } = require('./utils/shell-utils');

describe('script-name', () => {
  beforeEach(() => {
    setupTestEnv();
  });

  afterEach(() => {
    cleanupTestEnv();
  });

  it('should perform expected behavior', async () => {
    const result = await runShellCommand('./script-name');
    expect(result).toMatchSnapshot();
  });
});
```

### Running Tests

Script tests can be run using:

```bash
# Run all script tests
npm run test:scripts

# Run a specific script test
npm run test:scripts -- scripts/__tests__/git-hooks.test.js
```

Note: When running specific test files, use the `--` flag to pass arguments to the underlying Jest command.

For more details about the testing infrastructure, see the test utilities documentation in `__tests__/utils/`.
